<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports - Canteen POS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .content-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 15px;
    }
    .stat-box h3 { font-size: 2rem; margin: 0; }
    .stat-box p { margin: 5px 0 0 0; opacity: 0.9; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">ðŸ“Š Sales Reports</span>
      <div class="d-flex align-items-center text-white">
        <span class="me-3" id="userInfo"></span>
        <a href="dashboard.html" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="content-card">
      <h4 class="mb-4">Generate Sales Report</h4>
      
      <div class="row mb-4">
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" id="startDate">
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" id="endDate">
        </div>
        <div class="col-md-3">
          <label class="form-label">Group By</label>
          <select class="form-select" id="groupBy">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary w-100" onclick="generateReport()">Generate Report</button>
        </div>
      </div>

      <!-- SUMMARY STATS------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
      <div class="row mb-4" id="summaryStats" style="display: none;">
        <div class="col-md-4">
          <div class="stat-box">
            <h3 id="totalSales">â‚±0.00</h3>
            <p>Total Sales</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-box">
            <h3 id="totalTransactions">0</h3>
            <p>Total Transactions</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-box">
            <h3 id="avgSale">â‚±0.00</h3>
            <p>Average Sale</p>
          </div>
        </div>
      </div>

      <!-- SALES REPORT TABLE------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Period</th>
              <th>Transactions</th>
              <th>Total Sales</th>
              <th>Average Sale</th>
            </tr>
          </thead>
          <tbody id="reportTable">
            <tr>
              <td colspan="4" class="text-center text-muted">
                Select date range and click "Generate Report"
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="btn btn-success mt-3" onclick="exportReport()" id="exportBtn" style="display: none;">
        ðŸ“¥ Export to CSV
      </button>
    </div>

    <!-- RECENT TRANSACTIONS------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
    <div class="content-card">
      <h4 class="mb-4">Recent Transactions</h4>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Transaction ID</th>
              <th>Date & Time</th>
              <th>Cashier</th>
              <th>Total Amount</th>
              <th>Payment Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="transactionsTable">
            <tr>
              <td colspan="6" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TRANSACTION DETAILS MODAL------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Transaction Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailsContent">
          Loading...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  const API_URL = 'http://localhost:3000/api';
  let user = null;
  let reportData = [];

  // ON PAGE LOAD-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  window.onload = () => {
    user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    
    document.getElementById('userInfo').textContent = `${user.full_name} (${user.role})`;
    
    // Default date range = last 7 days
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = weekAgo;
    
    loadRecentTransactions();
  };

  // GENERATE SALES REPORT-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  async function generateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const groupBy = document.getElementById('groupBy').value;
    
    if (!startDate || !endDate) {
      alert('Please select start and end dates');
      return;
    }
    
    try {
      const response = await fetch(`${API_URL}/reports/sales?start_date=${startDate}&end_date=${endDate}&group_by=${groupBy}`);
      const data = await response.json();
      
      if (data.success) {
        reportData = data.report;
        displayReport(data.report);
        document.getElementById('exportBtn').style.display = 'block';
      }
    } catch (error) {
      console.error('Generate report error:', error);
      alert('Failed to generate report');
    }
  }

  function displayReport(report) {
    const tbody = document.getElementById('reportTable');
    const summaryStats = document.getElementById('summaryStats');
    
    if (report.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center">No data for selected period</td></tr>';
      summaryStats.style.display = 'none';
      return;
    }
    
    let totalSales = 0;
    let totalTransactions = 0;
    let html = '';
    
    report.forEach(row => {
      totalSales += parseFloat(row.total_sales);
      totalTransactions += parseInt(row.total_transactions);
      
      html += `
        <tr>
          <td>${row.period}</td>
          <td>${row.total_transactions}</td>
          <td>â‚±${parseFloat(row.total_sales).toFixed(2)}</td>
          <td>â‚±${parseFloat(row.avg_sale).toFixed(2)}</td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
    
    document.getElementById('totalSales').textContent = `â‚±${totalSales.toFixed(2)}`;
    document.getElementById('totalTransactions').textContent = totalTransactions;
    document.getElementById('avgSale').textContent = `â‚±${(totalSales / totalTransactions).toFixed(2)}`;
    summaryStats.style.display = 'flex';
  }

  // LOAD RECENT TRANSACTIONS-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  async function loadRecentTransactions() {
    try {
      const response = await fetch(`${API_URL}/sales`);
      const data = await response.json();

      if (data.success && Array.isArray(data.sales)) {
        if (data.sales.length === 0) {
          document.getElementById('transactionsTable').innerHTML =
            '<tr><td colspan="6" class="text-center text-muted">No transactions found</td></tr>';
        } else {
          displayTransactions(data.sales.slice(0, 20));
        }
      } else {
        document.getElementById('transactionsTable').innerHTML =
          '<tr><td colspan="6" class="text-center text-danger">Failed to load transactions.</td></tr>';
      }
    } catch (error) {
      console.error('Load transactions error:', error);
      document.getElementById('transactionsTable').innerHTML =
        '<tr><td colspan="6" class="text-center text-danger">Server error loading transactions.</td></tr>';
    }
  }

  // DISPLAY TRANSACTIONS-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  function displayTransactions(sales) {
    const tbody = document.getElementById('transactionsTable');
    let html = '';

    sales.forEach(sale => {
      html += `
        <tr>
          <td>#${sale.id}</td>
          <td>${formatDateTime(sale.transaction_date)}</td>
          <td>${sale.cashier_name || 'N/A'}</td>
          <td><strong>â‚±${parseFloat(sale.total_amount).toFixed(2)}</strong></td>
          <td>
            <span class="badge bg-${sale.payment_method === 'cash' ? 'success' : 'primary'}">
              ${sale.payment_method ? sale.payment_method.toUpperCase() : 'N/A'}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-info" onclick="viewDetails(${sale.id})">View</button>
          </td>
        </tr>`;
    });

    tbody.innerHTML = html;
  }

  // VIEW TRANSACTION DETAILS-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  async function viewDetails(saleId) {
    try {
      const response = await fetch(`${API_URL}/sales/${saleId}`);
      const data = await response.json();

      if (data.success) showDetailsModal(data.sale, data.items);
      else alert('Failed to load sale details');
    } catch (error) {
      console.error('Load sale details error:', error);
      alert('Error loading sale details');
    }
  }

  // RECIEPT MODAL-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  function showDetailsModal(sale, items) {
    const content = document.getElementById('detailsContent');

    let html = `
      <div class="mb-3">
        <h6>Transaction #${sale.id}</h6>
        <p><strong>Date:</strong> ${formatDateTime(sale.transaction_date)}</p>
        <p><strong>Cashier:</strong> ${sale.cashier_name}</p>
        <p><strong>Payment Method:</strong> ${sale.payment_method.toUpperCase()}</p>
      </div>

      <table class="table">
        <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr></thead>
        <tbody>`;

    items.forEach(item => {
      html += `
        <tr>
          <td>${item.product_name}</td>
          <td>${item.quantity}</td>
          <td>â‚±${parseFloat(item.price).toFixed(2)}</td>
          <td>â‚±${parseFloat(item.subtotal).toFixed(2)}</td>
        </tr>`;
    });

    html += `
        </tbody>
        <tfoot>
          <tr><td colspan="3" class="text-end"><strong>Total:</strong></td><td><strong>â‚±${parseFloat(sale.total_amount).toFixed(2)}</strong></td></tr>
          <tr><td colspan="3" class="text-end">Amount Paid:</td><td>â‚±${parseFloat(sale.amount_paid).toFixed(2)}</td></tr>
          <tr><td colspan="3" class="text-end">Change:</td><td>â‚±${parseFloat(sale.change_amount).toFixed(2)}</td></tr>
        </tfoot>
      </table>`;

    content.innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
  }

  // EXPORT TO CSV-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  function exportReport() {
    if (reportData.length === 0) {
      alert('No data to export');
      return;
    }

    let csv = 'Period,Transactions,Total Sales,Average Sale\n';
    reportData.forEach(row => {
      csv += `${row.period},${row.total_transactions},${row.total_sales},${row.avg_sale}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sales-report-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  }

  // HELPER FUNCTIONS-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', { 
      year: 'numeric', month: 'short', day: 'numeric', 
      hour: '2-digit', minute: '2-digit'
    });
  }

  function logout() {
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
